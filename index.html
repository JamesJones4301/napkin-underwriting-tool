
<!-- FULL HTML WITH EXPORT BUTTON INCLUDED -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Napkin Underwriting Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen">
  <div id="root" class="p-6"></div>
  <script>
    const { useState, useEffect, createElement: e } = React;

    function NapkinUnderwritingTool() {
      const [data, setData] = useState({
        units: 200,
        currentRent: 1500,
        marketRent: 1700,
        expenseTotal: 1820000,
        purchasePrice: 3500000,
        purchaseCap: 6,
        exitCap: 5.5,
        vintage: 1985,
        location: "Houston, TX",
        avgIncome: 52000,
        popGrowth: "Positive",
        floodZone: false,
        crimeGrade: "B",
        boilerChiller: false,
        coastal: false,
        rentControl: false,
        allBillsPaid: false
      });

      const [results, setResults] = useState({});

      useEffect(() => calculateResults(), [data]);

      const handle = (field, value) => {
        setData(prev => ({
          ...prev,
          [field]: typeof value === "string" ? value : parseFloat(value) || 0
        }));
      };

      const fCur = v => v ? "$" + v.toLocaleString(undefined, { maximumFractionDigits: 0 }) : "-";
      const fPct = v => v ? v.toFixed(1) + "%" : "-";

      const calculateResults = () => {
        const grossIncomeCurrent = data.units * data.currentRent * 12;
        const expenseRatio = data.expenseTotal / grossIncomeCurrent;
        const noiCurrent = grossIncomeCurrent * (1 - expenseRatio);
        const valueCurrent = noiCurrent / (data.purchaseCap / 100);

        const grossIncomeMarket = data.units * data.marketRent * 12;
        const noiMarket = grossIncomeMarket * (1 - expenseRatio);
        const valueMarket = noiMarket / (data.exitCap / 100);
        const upsidePercent = ((valueMarket - valueCurrent) / valueCurrent) * 100;

        const buyBox = {
          price: data.purchasePrice >= 10000000 && data.purchasePrice <= 40000000,
          vintage: data.vintage >= 1980,
          units: data.units >= 100 && data.units <= 300,
          income: data.avgIncome >= 50000,
          popGrowth: data.popGrowth.toLowerCase() === "positive",
          floodZone: !data.floodZone,
          crime: ["A", "B", "C"].includes(data.crimeGrade)
        };

        const redFlags = {
          boilerChiller: data.boilerChiller,
          coastal: data.coastal,
          rentControl: data.rentControl,
          allBillsPaid: data.allBillsPaid
        };

        const buyBoxFit = Object.values(buyBox).every(Boolean);
        const dealBreaker = Object.values(redFlags).some(Boolean);
        const decision = dealBreaker ? "‚ùå PASS - Red Flag Triggered"
                       : upsidePercent >= 20 && buyBoxFit && expenseRatio <= 0.5
                         ? "‚úÖ MOVE FORWARD"
                         : "‚ö†Ô∏è CAUTION - Needs Review";

        setResults({
          grossIncomeCurrent, noiCurrent, valueCurrent,
          grossIncomeMarket, noiMarket, valueMarket,
          expenseRatio, upsidePercent,
          buyBox, redFlags, decision
        });
      };

      const exportDeal = () => {
        const exportData = {
          inputs: data,
          results: results
        };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "napkin-deal.json";
        link.click();
      };

      return e("div", { className: "max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6" },
        e("h1", { className: "text-3xl font-bold text-indigo-700" }, "üìä Napkin Underwriting Tool"),

        e("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
          // Inputs
          e("div", {},
            ...[
              ["Units", "units"],
              ["Current Rent", "currentRent"],
              ["Market Rent", "marketRent"],
              ["Total Expenses (Annual)", "expenseTotal"],
              ["Purchase Price", "purchasePrice"],
              ["Purchase Cap Rate (%)", "purchaseCap"],
              ["Exit Cap Rate (%)", "exitCap"],
              ["Vintage Year", "vintage"],
              ["Average Income", "avgIncome"]
            ].map(([label, key]) =>
              e("div", { key },
                e("label", { className: "block text-sm font-medium text-gray-700" }, label),
                e("input", {
                  type: "number",
                  value: data[key],
                  onChange: e => handle(key, e.target.value),
                  className: "w-full p-2 border border-gray-300 rounded-lg mb-2"
                })
              )
            ),
            e("label", { className: "block text-sm font-medium text-gray-700" }, "Population Growth"),
            e("select", {
              value: data.popGrowth,
              onChange: e => handle("popGrowth", e.target.value),
              className: "w-full mb-2 border border-gray-300 rounded-lg p-2"
            },
              e("option", { value: "Positive" }, "Positive"),
              e("option", { value: "Negative" }, "Negative")
            ),
            e("label", { className: "block text-sm font-medium text-gray-700" }, "Crime Grade"),
            e("select", {
              value: data.crimeGrade,
              onChange: e => handle("crimeGrade", e.target.value),
              className: "w-full mb-2 border border-gray-300 rounded-lg p-2"
            },
              ["A", "B", "C", "D", "F"].map(g => e("option", { key: g }, g))
            ),
            ...[
              ["Flood Zone", "floodZone"],
              ["Boiler/Chiller", "boilerChiller"],
              ["Coastal", "coastal"],
              ["Rent Control", "rentControl"],
              ["All Bills Paid", "allBillsPaid"]
            ].map(([label, key]) =>
              e("div", { key, className: "flex items-center space-x-2" },
                e("input", {
                  type: "checkbox",
                  checked: data[key],
                  onChange: e => handle(key, e.target.checked)
                }),
                e("label", null, label)
              )
            )
          ),

          // Results
          e("div", { className: "space-y-4" },
            e("div", { className: "bg-indigo-100 p-4 rounded-lg" },
              e("h2", { className: "text-lg font-semibold" }, "Current Performance"),
              e("p", null, "NOI: ", fCur(results.noiCurrent)),
              e("p", null, "Value: ", fCur(results.valueCurrent)),
              e("p", null, "Expense Ratio: ", fPct((results.expenseRatio || 0) * 100))
            ),
            e("div", { className: "bg-green-100 p-4 rounded-lg" },
              e("h2", { className: "text-lg font-semibold" }, "Proforma Performance"),
              e("p", null, "NOI: ", fCur(results.noiMarket)),
              e("p", null, "Value: ", fCur(results.valueMarket)),
              e("p", null, "Upside: ", fPct(results.upsidePercent))
            ),
            e("div", { className: "bg-gray-100 p-4 rounded-lg" },
              e("h2", { className: "text-lg font-semibold" }, "Decision"),
              e("p", { className: "text-xl font-bold" }, results.decision || "-")
            ),
            e("button", {
              onClick: exportDeal,
              className: "bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mt-2"
            }, "üìÅ Export Deal JSON")
          )
        )
      );
    }

    ReactDOM.render(React.createElement(NapkinUnderwritingTool), document.getElementById("root"));
  </script>
</body>
</html>
